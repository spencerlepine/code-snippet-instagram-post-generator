name: Build Draft

on:
  workflow_dispatch:
    inputs:
      snippet_name:
        type: string
        description: drafts/<snippet_name>
        required: true

env:
  tmp_folder: ./generator/src/tmp

jobs:

  generator_snippet:
    name: "ğŸ— Generate Snippet"
    runs-on: ubuntu-latest
    environment: admin

    steps:
      - name: "â˜ï¸ Check out Git Repository"
        uses: actions/checkout@v2

      - name: "ğŸ”§ Set up Node"
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: "âš¡ Cache dependencies"
        uses: actions/cache@v3
        id: modules-cache
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}

      - name: "ğŸ“¦ Install dependencies"
        if: steps.modules-cache.outputs.cache-hit != 'true'
        working-directory: ./generator
        run: npm install

      - name: "ğŸ”§ Create the /tmp folder [GENERATOR]"
        working-directory: ./generator/src/
        run: mkdir tmp

      - name: "ğŸ” Search for snippet draft folder"
        run: test -d ./drafts/${{ github.event.inputs.snippet_name }}/ && echo "âœ… Folder exists" || (echo âŒ Folder not found && exit 1)

      - name: "ğŸ”§ Copy snippet draft into /tmp folder"
        run: cp -r ./drafts/${{ github.event.inputs.snippet_name }}/ ./generator/src/tmp

      - name: "ğŸ§ª Generator Snippet Screenshot"
        working-directory: ./generator
        run: npm run generate:screenshot --if-present

      - name: "â˜ï¸ Upload snippet build to artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: snippet-output-${{ github.sha }}
          path: ./generator/src/tmp
          retention-days: 5

      - name: "â¬‡ï¸ Download the client test coverage report"
        uses: actions/download-artifact@v3
        with:
          name: snippet-output-${{ github.sha }}

      - name: "ğŸ” Search for snippet output folder"
        run: test -d ./tmp && echo "âœ… Folder exists" || (echo âŒ Folder not found && exit 1)

      - name: "ğŸ”§ Copy snippet output into snippets folder"
        run: cp -r ./tmp ./snippets/${{ github.event.inputs.snippet_name }}

      - name: "ğŸ§½ Clean up snippet draft"
        run: rm -f ./drafts/${{ github.event.inputs.snippet_name }}

      - name: "ğŸš€ Commit ${{ github.event.inputs.snippet_name }} snippet build"
        run: |
          git config pull.rebase false
          git pull
          git add .
          git config --global user.name "SpencerBot"
          git config --global user.email "spencerbot@example.com"
          git commit -m "ğŸš€ [Automated] Generator new snippet (${{ github.event.inputs.snippet_name }})"