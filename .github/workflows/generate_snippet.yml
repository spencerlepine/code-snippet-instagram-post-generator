name: Generate Snippet

on:
  workflow_dispatch:
    inputs:
      snippet_name:
        type: string
        description: drafts/<snippet_folder_name>
        required: true

jobs:
  input_check:
    name: "ğŸš§ Validate Action Inputs"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸš§ Test [snippet_name] input with regex"
        uses: actions-ecosystem/action-regex-match@v2
        id: regex-match
        with:
          text: ${{ github.event.inputs.snippet_name }}
          regex: '[a-z-]'

      - name: "ğŸš« Deny invalid snippet [snippet_name] input"
        if: ${{ steps.regex-match.outputs.match == '' }}
        run: |
          echo "Invalid snippet folder name"
          exit 1

      - name: "â˜ï¸ Check out Git Repository"
        uses: actions/checkout@v2

      - name: "ğŸš§ Verify snippet exists in draft folder"
        run: test -d ./drafts/${{ github.event.inputs.snippet_name }}/ && echo "âœ… Folder exists" || (echo âŒ Folder not found && exit 1)

      - name: "ğŸš§ Verify snippet DOES NOT exist in output folder"
        run: test -d ./snippets/${{ github.event.inputs.snippet_name }}/ && (echo âŒ Existing snippet found && exit 1) || echo "âœ… No existing snippet folder"

  generator_snippet:
    needs: [input_check]
    name: "ğŸ— Test Snippet Generator"
    runs-on: ubuntu-latest
    environment: admin

    steps:
      - name: "ğŸš§ Test input with regex"
        uses: actions-ecosystem/action-regex-match@v2
        id: regex-match
        with:
          text: ${{ github.event.inputs.snippet_name }}
          regex: '[a-z-]'

      - name: "ğŸš« Deny invalid snippet name input"
        if: ${{ steps.regex-match.outputs.match == '' }}
        run: |
          echo "Invalid snippet name input (example: my-cool-snippet)"
          exit 1

      - name: "â˜ï¸ Check out Git Repository"
        uses: actions/checkout@v2

      - name: "ğŸš§ Verify snippet exists in draft folder"
        run: test -d ./drafts/${{ github.event.inputs.snippet_name }}/ && echo "âœ… Folder exists" || (echo âŒ Folder not found && exit 1)

      - name: "ğŸš§ Verify snippet DOES NOT exist in output folder"
        run: test -d ./snippets/${{ github.event.inputs.snippet_name }}/ && (echo âŒ Existing snippet found && exit 1) || echo "âœ… No existing snippet folder"

      - name: "ğŸ”§ Set up Node"
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: "âš¡ Cache dependencies"
        uses: actions/cache@v3
        id: modules-cache
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}

      - name: "ğŸ“¦ Install dependencies"
        if: steps.modules-cache.outputs.cache-hit != 'true'
        working-directory: ./generator
        run: npm install

      - name: "ğŸ”§ Create the [./generator/src/tmp] folder"
        working-directory: ./generator/src/
        run: mkdir tmp

      - name: "ğŸ”§ Copy snippet draft into [./generator/src/tmp] folder"
        run: cp -a ./drafts/${{ github.event.inputs.snippet_name }}/. ./generator/src/tmp/

      - name: "ğŸ§ª Generate the snippet Screenshot"
        working-directory: ./generator
        run: npm run generate:screenshot --if-present

      - name: "ğŸ”§ Create snippet output folder"
        working-directory: ./generator/src/
        run: |
          mkdir output
          cd output
          mkdir tmp
          cd ..
          cp -a ./tmp/. ./output/tmp/

      - name: "â˜ï¸ Upload snippet build to artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: snippet-output-${{ github.sha }}
          path: ./generator/src/output
          retention-days: 5

      - name: "â¬‡ï¸ Download the snippet build from artifacts"
        uses: actions/download-artifact@v3
        with:
          name: snippet-output-${{ github.sha }}

      - name: "ğŸ” Search for snippet output folder"
        run: test -d ./tmp && echo "âœ… Folder exists" || (echo âŒ Folder not found && exit 1)

      - name: "ğŸ”§ Create snippets output folder"
        run: mkdir -p snippets

      - name: "ğŸ”§ Create output snippet folder"
        run: mkdir -p ./snippets/${{ github.event.inputs.snippet_name }}

      - name: "ğŸš— Copy snippet output into snippets folder"
        run: cp -r ./tmp/. ./snippets/${{ github.event.inputs.snippet_name }}

      - name: "â¬‡ï¸ List output snippets folders"
        run: cd snippets && ls

      - name: "ğŸ§½ Clean up temporary snippet files"
        run: |
          rm -rf ./generator/src/output
          rm -rf ./drafts/${{ github.event.inputs.snippet_name }}

      - name: "ğŸš€ Commit [${{ github.event.inputs.snippet_name }}] snippet build"
        run: |
          git config pull.rebase false
          git pull
          git add .
          git config --global user.name "SnippetGeneratorBot"
          git config --global user.email "spencerbot@example.com"
          git commit -m "ğŸš€ [Automated] Generated new snippet (${{ github.event.inputs.snippet_name }})"

      - name: "ğŸš€ Push NEW snippet to repo"
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}